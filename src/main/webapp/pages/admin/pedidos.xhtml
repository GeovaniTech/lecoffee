<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
	lang="#{MBAppConfigs.appConfigs.language}"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:components="http://java.sun.com/jsf/composite/components"
	xmlns:a="http://xmlns.jcp.org/jsf/passthrough">
	
	<h:body>
		<ui:composition template="/templates/admin/layout.xhtml">
			<ui:define name="name_page">
				<h:outputText value="#{label.orders}" />
			</ui:define>
			
			<ui:define name="body">
				<style>
					#menu-pedidos {
						background-color: var(--background-general-mouse);
						color: var(--text-mouse);
					}
					
					#menu-pedidos > * {
						color: var(--text-mouse);
					}
					
					.style {
						padding: 5px 10px;
						border-radius: 30px;
					  	display: inline-block;
					 	width: auto;
					 	font-size: 14px;
					 	color: black;
					}
					
					.card-insights-orders {
						padding: 10px 15px;
						border-radius: 10px;
						background-color: var(--background-general);
						width: 200px;
						margin: 10px 10px; 
						margin-bottom: 20px;
					}
					
					.card-insights-orders p {
						font-size: 25px;
					}
					
					.icon-insights {
						color: var(--text-mouse);
						font-size: 25px !important;
						margin-top: 8px;
					}
				</style>
				
				<h:form id="formCardInsights">
					<p:remoteCommand 
						name="updateCards"
						update="@form"/>
				
					<div class="horizontal-evenly">
						<div class="card-insights-orders horizontal-between">
							<div class="vertical-left">
								<h3>A Confimar</h3>
								<i class="pi pi-clock icon-insights"></i>
							</div>
							
							<p:divider layout="vertical" />
							
							<div class="vertical-right">
								<p>#{MBClientOrder.totalAConfirmar}</p>
							</div>
						</div>
						
						<div class="card-insights-orders horizontal-between">
							<div class="vertical-left">
								<h3>Em Preparo</h3>
								
								<i class="pi pi-spinner icon-insights"></i>
							</div>
							
							<p:divider layout="vertical" />
							
							<div class="vertical-right">
								<p>#{MBClientOrder.totalEmPreparo}</p>
							</div>
						</div>
						
						<div class="card-insights-orders horizontal-between">
							<div class="vertical-left">
								<h3>Enviado</h3>
								
								<i class="pi pi-send icon-insights"></i>
							</div>
						
							<p:divider layout="vertical" />
							
							<div class="vertical-right">
								<p>#{MBClientOrder.totalEnviado}</p>
							</div>
						</div>
						
						<div class="card-insights-orders horizontal-between">
							<div class="vertical-left">
								<h3>Finalizado</h3>
								
								<i class="pi pi-check-circle icon-insights"></i>
							</div>
							
							<p:divider layout="vertical" />
							
							<div class="vertical-right">
								<p>#{MBClientOrder.totalFinalizado}</p>
							</div>
						</div>
						
						<div class="card-insights-orders horizontal-between">
							<div class="vertical-left">
								<h3>Cancelado</h3>
								<i class="pi pi-times-circle icon-insights"></i>
							</div>
							
							<p:divider layout="vertical" />
							
							<div class="vertical-right">
								<p>#{MBClientOrder.totalCancelado}</p>
							</div>
						</div>
					</div>
				</h:form>
				
				<div class="mg-b-10">
					<h:form>
						<p:commandButton 
							icon="pi pi-filter"
							action="#{MBClientOrder.changeToggleFilter()}"
							update="formTableOrders:tableOrders"
							styleClass="optionsButtonStyle mg-r-5" />
							
						<p:commandButton 
							icon="pi pi-filter-slash"
							update="formTableOrders:tableOrders"
							styleClass="optionsButtonStyle"
							oncomplete="PF('tableOrders').clearFilters();" />
					</h:form>
				</div>
				
				<h:form id="formTableOrders">
					<p:poll 
						id="orderPoll"
						interval="10"
						listener="#{MBClientOrder.list()}"
						update="@form"
						oncomplete="updateCards();" />
				
					<p:dataTable
						id="tableOrders"
						widgetVar="tableOrders"
						var="order"
						value="#{MBClientOrder.orders}"
						rowKey="#{order.id}"
						scrollable="true"
						styleClass="#{MBClientOrder.toggleFilter == false ? 'hide-filters' : ''}">
						
			            <p:column style="width:2rem">
			                <p:rowToggler />
			            </p:column>
						
						<p:column 
							headerText="#{label.client}" 
							filterBy="#{order.client.nome}"
							filterMatchMode="contains">
							
							<f:facet name="filter">
								<p:inputText>
									<p:ajax 
										event="keyup" 
										delay="500"
										oncomplete="PF('tableOrders').filter()" />
								</p:inputText>
							</f:facet>
							
							<h:outputText value="#{order.client.nome eq '' or order.client.nome == null ? order.client.email : order.client.nome}" />
						</p:column>
						
						<p:column 
							headerText="#{label.email}" 
							filterBy="#{order.client.email}"
							filterMatchMode="contains">
							
							<f:facet name="filter">
								<p:inputText>
									<p:ajax 
										event="keyup" 
										delay="500"
										oncomplete="PF('tableOrders').filter()" />
								</p:inputText>
							</f:facet>
							
							<h:outputText value="#{order.client.email}" />
						</p:column>
						
						<p:column 
							headerText="#{label.delivery_address}"
							filterBy="#{order.address.street}"
							filterMatchMode="contains">
							
							<f:facet name="filter">
								<p:inputText>
									<p:ajax 
										event="keyup" 
										delay="500"
										oncomplete="PF('tableOrders').filter()" />
								</p:inputText>
							</f:facet>
						
							<h:outputText value="#{order.address.street}, #{order.address.house_number}" />
						</p:column>
						
						<p:column 
							headerText="#{label.neighborhood}"
							filterBy="#{order.address.neighborhood}"
							filterMatchMode="contains">
							
							<f:facet name="filter">
								<p:inputText>
									<p:ajax 
										event="keyup" 
										delay="500"
										oncomplete="PF('tableOrders').filter()" />
								</p:inputText>	
							</f:facet>
							
							<h:outputText value="#{order.address.neighborhood}" />
						</p:column>
						
						<p:column 
							headerText="Total">
							<h:outputText value="#{MBAppConfigs.getBrazilianCurrency(MBClientOrder.getTotalOrder(order.cart.id))}" />
						</p:column>
						
						<p:column 
							headerText="#{label.request_date}"
							filterBy="#{order.creationDate}">
							
							<f:facet name="filter">
								<p:datePicker pattern="dd/MM/yyyy">
									<p:ajax 
										event="valueChange" 
										oncomplete="PF('tableOrders').filter()" />
									
									<p:ajax 
										event="keyup" 
										delay="500"
										oncomplete="PF('tableOrders').filter()" />
								</p:datePicker>
							</f:facet>
							
							<h:outputText value="#{order.creationDate}">
								<f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
							</h:outputText>
						</p:column>
						
						<p:column 
							headerText="Status"
							filterBy="#{order.status}">
							
							<f:facet name="filter">
								<p:selectOneMenu style="width: 200px;">
									<f:selectItem 
										itemLabel="#{label.all}"
										itemValue="#{null}" />
									
									<f:selectItem 
										itemLabel="A confirmar"
										itemValue="A confirmar" />

									<f:selectItem 
										itemLabel="Em preparo"
										itemValue="Em preparo" />

									<f:selectItem 
										itemLabel="Enviado"
										itemValue="Enviado" />

									<f:selectItem 
										itemLabel="Finalizado"
										itemValue="Finalizado" />

									<f:selectItem 
										itemLabel="Cancelado"
										itemValue="Cancelado" />
										
									<p:ajax 
										event="valueChange" 
										oncomplete="PF('tableOrders').filter()" />
								</p:selectOneMenu>
							</f:facet>
							<div class="style vertical-center" style="background-color: #{order.status eq 'A confirmar' ? '#ffcc00' : order.status eq 'Finalizado' ? '#339900' : order.status eq 'Cancelado' ? '#cc3300' : order.status eq 'Em preparo' ? '#00bcd4' : order.status eq 'Enviado' ? '#ed4981;' :''}">
								<h:outputText value="#{order.status}" />
							</div>
						</p:column>
						
						<p:column 
							headerText="#{label.payment}"
							filterBy="#{order.payment.name}">
							
							<f:facet name="filter">
								<p:selectOneMenu style="width: 200px;">
									<f:selectItem 
										itemLabel="#{label.all}"
										itemValue="#{null}" />
									
									<f:selectItems 
										var="payment"
										value="#{MBPayment.payments}"
										itemLabel="#{payment.name}"
										itemValue="#{payment.name}" />
										
									<p:ajax 
										event="valueChange" 
										oncomplete="PF('tableOrders').filter()" />
								</p:selectOneMenu>
							</f:facet>
							
							<h:outputText value="#{order.payment.name}" />
						</p:column>
						
						<p:rowExpansion>
							<h3 class="mg-b-10">#{label.products}</h3>
							<ui:repeat var="item" value="#{order.cart.items}">
								<div class="horizontal-left-center mg-b-10">
									<h:graphicImage value="data:image/png;base64,#{MBAppConfigs.getRenderedImage(item.product.imageBytes)}" class="mg-r-10" style="width: 50px; height: 50px; border-radius: 10px;"/>
									<h:outputText value="#{item.amount}un" style="margin-right: 10px;" />
									<h:outputText value="#{item.product.name}" />
								</div>
							</ui:repeat>
							
							<p:toolbar>
								<f:facet name="left">
									<p:commandButton 
										icon="pi pi-check-circle"
										value="#{label.accept}"
										action="#{MBClientOrder.acceptOrder(order.id)}"
										styleClass="mg-r-5"
										update="@form"
										oncomplete="updateCards();"
										rendered="#{order.status eq 'A confirmar' ? true : false}" />

									<p:commandButton 
										icon="pi pi-send"
										value="#{label.send}"
										action="#{MBClientOrder.sendOrder(order.id)}"
										update="@form"
										styleClass="mg-r-5"
										oncomplete="updateCards();"
										rendered="#{order.status eq 'Em preparo'}" />
										
									<p:commandButton 
										icon="pi pi-check-square"
										value="#{label.finish}"
										action="#{MBClientOrder.finishOrder(order.id)}"
										update="@form"
										styleClass="mg-r-5"
										oncomplete="updateCards();"
										rendered="#{order.status eq 'Enviado'}" />
								
									<p:commandButton 
										icon="pi pi-trash"
										value="#{label.cancel}"
										action="#{MBClientOrder.cancelOrder(order.id)}"
										styleClass="deleteStyle mg-r-5"
										update="@form"
										oncomplete="updateCards();"
										rendered="#{order.status != 'Finalizado' and order.status != 'Cancelado' ? true : false}" />
								</f:facet>
							</p:toolbar>
						</p:rowExpansion>
					</p:dataTable>
				</h:form>
			</ui:define>
		</ui:composition>
	</h:body>
</html>